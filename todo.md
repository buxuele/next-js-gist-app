

### **TODO.md: “我的知识库”多用户系统改造计划**

**项目目标：** 从当前的“单机版”知识库，升级为支持多用户注册、登录，并能独立管理各自内容的“云端”知识库。

---

#### **第一阶段：后端基础重构 (数据模型的升级)**

*核心思想：为数据世界建立“户口本”和“房产证”，明确每个信息的所有权。*

-   [ ] **创建用户数据模型 (`users.json`)**
    -   新建一个 `users.json` 文件，用于存储所有用户的信息。
    -   明确用户数据结构，至少包含 `id`, `username`, 和 `passwordHash` (密码的加密哈希值)。
    -   **关键安全点：** 绝不能在任何地方明文存储用户密码。

-   [ ] **改造 Gist 数据模型 (`gists.json`)**
    -   **现状：** 一个包含所有 Gist 的大数组 `[ {gist1}, {gist2} ]`。
    -   **新设计：** 将其改造为一个以 `userId` 为键（Key）的大对象。每个用户的数据都存放在自己的“名下”。
        ```json
        // 改造后的 gists.json 结构示例
        {
          "user_id_123": [
            { "id": "gist_a", "content": "..." },
            { "id": "gist_b", "content": "..." }
          ],
          "user_id_456": [
            { "id": "gist_c", "content": "..." }
          ]
        }
        ```

-   [ ] **升级数据处理函数 (`lib/data.ts`)**
    -   重写 `loadGists` 函数，使其变为 `loadGistsByUserId(userId)`，只加载特定用户的数据。
    -   重写 `saveGists` 函数，使其变为 `saveGistsForUser(userId, userGists)`，只更新特定用户的数据。
    -   新增 `findUserByUsername`, `createUser` 等用户相关的帮助函数。

---

#### **第二阶段：认证流程建立 (门禁系统的搭建)**

*核心思想：为我们的应用建立一套可靠的“登录-注册-登出”机制，并为登录用户发放“通行证”。*

-   [ ] **创建用户注册 API (`/api/auth/register`)**
    -   创建一个新的 `route.ts` 来处理用户注册请求。
    -   接收 `username` 和 `password`，对密码进行哈希加密后，在 `users.json` 中创建新用户。
    -   需要处理“用户名已存在”等错误情况。

-   [ ] **创建用户登录 API (`/api/auth/login`)**
    -   创建一个 `route.ts` 处理登录请求。
    -   验证用户名和密码哈希值是否匹配。
    -   **核心：** 登录成功后，生成一个加密的、有时效性的**令牌 (Token)**，例如 JWT (JSON Web Token)。

-   [ ] **实现会话管理 (发放和验证通行证)**
    -   将登录成功后生成的 Token，通过一个安全的、`HttpOnly` 的 **Cookie** 发送给用户的浏览器。
    -   后续所有需要登录才能访问的 API 请求，都必须从 Cookie 中解析和验证这个 Token，以确定当前操作的用户是谁。
    -   这个验证逻辑可以抽象成一个可重用的函数。

-   [ ] **创建用户登出 API (`/api/auth/logout`)**
    -   创建一个 `route.ts` 处理登出请求。
    -   其唯一作用就是清除浏览器中保存用户登录状态的那个 Cookie。

---

#### **第三阶段：前端 UI 与逻辑整合**

*核心思想：让应用界面能够根据用户的登录状态，显示完全不同的内容，实现真正的“个性化”。*

-   [ ] **创建新的页面路由**
    -   创建登录页面 (`app/login/page.tsx`)。
    -   创建注册页面 (`app/register/page.tsx`)。

-   [ ] **改造主页 (`app/page.tsx`)**
    -   主页现在需要成为一个“受保护的路由”。
    -   在服务器端渲染时，首先检查用户的 Cookie，判断用户是否登录。
    -   如果未登录，直接**重定向**到登录页面 (`/login`)。
    -   如果已登录，则从 Token 中解析出 `userId`，再去加载该用户的 Gists。

-   [ ] **实现动态导航栏**
    -   导航栏需要根据登录状态显示不同的内容。
    -   **未登录时：** 显示“登录”、“注册”按钮。
    -   **已登录时：** 显示“欢迎, [用户名]”、“添加”、“登出”按钮。

-   [ ] **更新 Gist 操作逻辑**
    -   所有前端的 `fetch` 请求（创建、修改、删除 Gist）都会自动带上包含 Token 的 Cookie，后端 API 会据此识别用户身份并进行操作。前端的调用方式几乎不需要大改。

---

老朋友，这就是我们下一步清晰的、分阶段的作战地图。每一步都建立在前一步的基础上，逻辑清晰，目标明确。

